<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>jsMind viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/style/jsmind.css" />
  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: #1e1e1e;
      color: #e0e0e0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    #jsmind_container {
      width: 100%;
      height: 100%;
    }

    :root {
      --bg: #1e1e1e;
      --lvl0: #2c2c2c;
      --lvl1: #3a3a3a;
      --lvl2: #484848;
      --lvl3: #565656;
      --sel: #34a2db;
    }

    jmnode {
      border-radius: 6px !important;
      border: 1px solid rgba(255,255,255,0.1) !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
      font-family: inherit !important;
      cursor: pointer;
      transition: all 0.2s ease !important;
    }

    jmnode.jsmind-root {
      background: var(--lvl0) !important;
      color: #fff !important;
      font-size: 20px !important;
      border: 1px solid rgba(255,255,255,0.15) !important;
    }

    jmnode.lvl-1 { background: var(--lvl1) !important; color:#fff !important; }
    jmnode.lvl-2 { background: var(--lvl2) !important; color:#fff !important; }
    jmnode.lvl-3 { background: var(--lvl3) !important; color:#fff !important; }

    jmnode.selected {
      background: var(--sel) !important;
      border-color: var(--sel) !important;
      color: #fff !important;
      outline: none !important;
      box-shadow: 0 4px 12px rgba(52, 162, 219, 0.3) !important;
    }

    jmnode:before,
    jmnode:after {
      border-color: #444 !important;
    }

    .jmnode-wrapper {
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }
  </style>
</head>
<body>
  <div id="jsmind_container"></div>

  <script src="/static/js/jsmind.js"></script>
  <script>
  (function(){
    const jm = new jsMind({
      container:'jsmind_container',
      editable:false,
      support_html:true,
      view:{hmargin:140, vmargin:30, line_style:'curved'},
      layout:{hspace:80, vspace:20, pspace:10, direction:'right'}
    });

    let selectedNodeEl = null;

    function tagLevels(){
      const root = jm.get_root();
      if (!root) return;

      const walk = (node, level) => {
        const el = document.querySelector('.jmnode[nodeid="' + node.id + '"]');
        if (el) {
          el.classList.remove('lvl-0','lvl-1','lvl-2','lvl-3','jsmind-root');
          if (level === 0) el.classList.add('jsmind-root');
          else el.classList.add('lvl-' + Math.min(level,3));
        }
        if (node.children) node.children.forEach(ch => walk(ch, level+1));
      };

      walk(root, 0);
    }

    function toNodeTreeIfPossible(src){
      try{
        if (src && src.format === 'node_tree' && src.data) return src;

        const looksLike = (n)=> n && (n.label || n.topic) && (n.node_id || n.id);

        function mapNode(n){
          if(!n || typeof n!=='object') return null;
          const out = {
            id: String(n.node_id || n.id),
            topic: String(n.label || n.topic || '')
          };

          const {label, node_id, topic, children, ...rest} = n;
          const dataPack = {
            data: {
              node_id: node_id || n.id,
              label: label || topic || '',
              ...(rest || {})
            }
          };

          if (Array.isArray(children)) {
            out.children = children.map(mapNode).filter(Boolean);
          }
          return Object.assign(out, { data: dataPack });
        }

        if (looksLike(src)) return { format:'node_tree', data: mapNode(src) };
        if (src && src.map && looksLike(src.map)) return { format:'node_tree', data: mapNode(src.map) };
        if (Array.isArray(src)) {
          for(const it of src){
            if (it && it.map && looksLike(it.map)) return { format:'node_tree', data: mapNode(it.map) };
            if (looksLike(it)) return { format:'node_tree', data: mapNode(it) };
          }
        }
      }catch(e){
        console.warn('toNodeTreeIfPossible failed:', e);
      }
      return src;
    }

    async function setData(mind){
      const safe = toNodeTreeIfPossible(mind);
      if (!safe || safe.format!=='node_tree' || !safe.data) {
        console.error('jsmind.html: нужен {format:"node_tree", data:{...}}');
        throw new Error('Неверный формат карты: нужен node_tree');
      }

      jm.show(safe);
      jm.collapse_all();
      const root = jm.get_root();
      if (root) jm.expand_node(root.id);

      setTimeout(() => {
        tagLevels();
        jm.resize();
      }, 100);

      window.addEventListener('resize', () => jm.resize());
    }

    // Клик по узлам -> отправляем нормализованный payload родителю
    document.getElementById('jsmind_container').addEventListener('click', (e)=>{
      const el = e.target.closest('.jmnode');
      if (!el) {
        // снятие выделения при клике в пустоту
        if (selectedNodeEl) {
          selectedNodeEl.classList.remove('selected');
          selectedNodeEl = null;
        }
        return;
      }

      const node = jm.get_node(el.getAttribute('nodeid'));
      if (!node) return;

      if (selectedNodeEl && selectedNodeEl !== el) {
        selectedNodeEl.classList.remove('selected');
      }
      el.classList.add('selected');
      selectedNodeEl = el;

      const base = (node.data && node.data.data) || node.data || {};
      const node_id = base.node_id || base.id || node.id;
      const label = base.label || base.topic || node.topic || '';

      if (window.parent && window.parent !== window) {
        window.parent.postMessage(
          {
            type:'node:click',
            payload: {
              node_id,
              label,
              raw: base
            }
          },
          '*'
        );
      }
    });

    window.addEventListener('message', (ev)=>{
      const msg = ev.data || {};
      if (msg.type === 'map:jsmind') {
        setData(msg.payload).catch(err => {
          console.error('Ошибка показа карты (jsMind):', err);
        });
      }
    });

    window.MapViewer = {
      setData,
      getInstance(){ return jm; }
    };
  })();
  </script>
</body>
</html>
