<!doctype html>
<!--
  FILE: index.html
  ROLE: Чистый viewer jsmind. Никаких вебхуков/форм. Только:
    - отдаёт контейнеру данные по выбранному узлу через postMessage
    - принимает данные карты через postMessage({type:'map:set', payload}) ИЛИ через window.MapViewer.setData(...)
  API:
    - window.MapViewer.setData(mindLike)  // показать карту
    - window.MapViewer.getInstance()      // вернуть jsMind instance
  Связь:
    - При клике по узлу публикует: postMessage({type:'container:set', payload: nodeLike})
    - Слушает:  postMessage({type:'map:set', payload: mindLike})
  Зависимости:
    - /static/style/jsmind.css
    - /static/js/jsmind.js
-->
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>sotiio map — viewer only</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/style/jsmind.css" />

  <style>
    html, body { height:100%; margin:0; overflow:hidden;
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif; }
    #jsmind_container { height:100vh; width:100vw; background:#ece0d1; overflow:visible; }

    /* Кофейная палитра + уровни */
    :root { --bg:#ece0d1; --lvl0:#dbc1ac; --lvl1:#967259; --lvl2:#634832; --lvl3:#38220f; --sel:#ff622b; }
    jmnode{ border-radius:10px!important; border:1px solid rgba(0,0,0,.1)!important;
            box-shadow:0 2px 4px rgba(0,0,0,.1)!important; font-family:inherit; }
    jmnode.jsmind-root { background:var(--lvl0)!important; color:#1f1f1f!important; font-size:20px!important; }
    jmnode.lvl-1 { background:var(--lvl1)!important; color:#fff!important; }
    jmnode.lvl-2 { background:var(--lvl2)!important; color:#fff!important; }
    jmnode.lvl-3 { background:var(--lvl3)!important; color:#fff!important; }
    jmnode.selected { background:var(--sel)!important; border-color:var(--sel)!important; color:#fff!important; outline:none!important; }
  </style>
</head>
<body>
  <div id="jsmind_container"></div>

  <script src="/static/js/jsmind.js"></script>
  <script>
  (function(){
    // --- Создаём jsMind (только viewer) ---
    const jm = new jsMind({
      container:'jsmind_container',
      editable:false, support_html:true,
      view:{ hmargin:140, vmargin:30, line_style:'curved' },
      layout:{ hspace:80, vspace:20, pspace:10, direction:'right' }
    });
    window.__jm = jm; // на всякий случай

    // --- Помощники: уровни для кастомных стилей ---
    function tagLevels() {
      const root = jm.get_root(); if(!root) return;
      const walk = (node, level) => {
        const el = document.querySelector(`.jmnode[nodeid="${node.id}"]`);
        if (el) {
          el.classList.remove('lvl-0','lvl-1','lvl-2','lvl-3','jsmind-root');
          if (level === 0) el.classList.add('jsmind-root');
          else el.classList.add('lvl-' + Math.min(level, 3));
        }
        (node.children||[]).forEach(ch => walk(ch, level+1));
      };
      walk(root, 0);
    }

    // --- Мини-конвертер (если к нам пришёл "почти-узловой" json, но не node_tree) ---
    function toNodeTreeIfPossible(src){
      try{
        // Уже node_tree?
        if (src && src.format === 'node_tree' && src.data) return src;

        // Похож на наш "map-root": { label, node_id, children }
        const looksLike = (n)=> n && (n.label || n.topic) && (n.node_id || n.id);
        function mapNode(n){
          if(!n || typeof n!=='object') return null;
          const out = {
            id: String(n.node_id||n.id),
            topic: String(n.label||n.topic||''),
          };
          // всё несистемное — в data
          const {label,node_id,topic,children,...rest} = n;
          const dataPack = { data: { node_id: node_id||n.id, label: label||topic||'', ...(rest||{}) } };
          if (Array.isArray(children)){
            out.children = children.map(mapNode).filter(Boolean);
          }
          return Object.assign(out, { data: dataPack });
        }

        if (looksLike(src)) return { format:'node_tree', data: mapNode(src) };
        if (src && src.map && looksLike(src.map)) return { format:'node_tree', data: mapNode(src.map) };
        if (Array.isArray(src)){
          for(const it of src){
            if (it && it.map && looksLike(it.map)) return { format:'node_tree', data: mapNode(it.map) };
            if (looksLike(it)) return { format:'node_tree', data: mapNode(it) };
          }
        }
      }catch(e){}
      // Не трогаем — пусть будет как есть (если это node_tree — покажется, если нет — бросим ошибку)
      return src;
    }

    // --- Показать карту ---
    async function setData(mind){
      const safe = toNodeTreeIfPossible(mind);
      if (!safe || safe.format!=='node_tree' || !safe.data) {
        console.error('index.html viewer: ожидаю {format:"node_tree", data:{...}}'); 
        throw new Error('Неверный формат карты: нужен node_tree');
      }
      jm.show(safe);
      jm.collapse_all();
      const root = jm.get_root(); if(root) jm.expand_node(root.id);
      setTimeout(()=>{ tagLevels(); jm.resize(); }, 80);
      window.addEventListener('resize', ()=> jm.resize());
    }

    // --- Клик по узлу -> отправим контейнеру node.data ---
    document.getElementById('jsmind_container').addEventListener('click', (e)=>{
      const el = e.target.closest('jmnode'); if(!el) return;
      const node = jm.get_node(el.getAttribute('nodeid')); if(!node) return;
      try {
        const envelope = { type:'container:set', payload: (node.data||{}) };
        // шлём и в parent (в случае iframe), и в opener (в случае окна)
        if (window.parent && window.parent !== window) window.parent.postMessage(envelope, '*');
        if (window.opener) window.opener.postMessage(envelope, '*');
      } catch(err){ console.warn('postMessage to container failed', err); }
    });

    // --- Слушаем внешнюю установку карты ---
    window.addEventListener('message', (ev)=>{
      const msg = ev.data || {};
      if (msg && msg.type === 'map:set') {
        setData(msg.payload).catch(err => alert('Ошибка показа карты: '+err.message));
      }
    });

    // --- Публичный API viewer-а ---
    window.MapViewer = {
      setData,
      getInstance(){ return jm; }
    };
  })();
  </script>
</body>
</html>
