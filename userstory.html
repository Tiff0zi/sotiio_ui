<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>sotiio user story</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      background: #f6f6f6;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      overflow: auto;
    }

    .wrap {
      max-width: 820px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 12px 32px rgba(0,0,0,.08);
      padding: 22px 26px;
      height: auto;
      min-height: 100%;
      position: relative;
    }
    h1 { margin: 6px 0 18px 0; font-size: 22px; color: #1f1f1f; }
    .row { margin: 18px 0; }
    .label { font-weight: 700; margin-bottom: 10px; font-size: 15px; }
    .roles { display: flex; flex-direction: column; gap: 10px; }
    .roles label { display: flex; align-items: center; gap: 10px;
      background: #fafafa; border: 1px solid #eee; border-radius: 8px; padding: 10px 12px; }
    .roles input[type="checkbox"] { width: 18px; height: 18px; }

    .btns { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 8px; }
    button {
      border: none;
      background: #333; color: #fff; font-weight: 700;
      padding: 10px 18px; border-radius: 8px; cursor: pointer; transition: .2s;
    }
    button:hover { background: #111; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .btn-secondary { background: #e9eff5; color: #222; }
    .btn-secondary:hover { background: #dae5ef; }

    .help {
      background: #f2f7fd; border: 1px solid #e3eef9;
      border-radius: 10px; padding: 12px 14px; color: #30465a;
      font-size: 14px; line-height: 1.45;
    }

    .tips small { color:#565656; }
    .tips .inline { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background: #f6f6f6; padding: 2px 6px; border-radius: 5px; border: 1px solid #eee; }
    .tips code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background: #f6f6f6; padding: 2px 6px; border-radius: 5px; border: 1px solid #eee; }

    .xhr-row {
      background: #f8f9fb; border: 1px dashed #e0e6ee;
      padding: 12px 12px; border-radius: 8px; color: #333;
      font-size: 14px;
    }

    .divider { height: 1px; background: #eee; margin: 18px 0; }
    .small { color:#555; font-size: 12px; }
    .legend { background: #f3f3f3; border: 1px solid #e8e8e8; border-radius: 8px; padding: 12px; color: #333; font-size: 13px; }

    .progress-bar {
      width: 100%; height: 6px; background: #eee;
      border-radius: 6px; overflow: hidden; margin-top: 10px;
    }
    .progress {
      height: 100%; background: #2670f0; width: 0%;
      transition: width 0.2s ease;
    }

    #log {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px; white-space: pre-wrap;
      background: #fcfcfc; border: 1px solid #eee; border-radius: 8px; padding: 10px 12px;
      color: #333; line-height: 1.45; max-height: 320px; overflow: auto;
    }

    .loading-overlay {
      position: fixed; inset: 0; display: none;
      align-items: center; justify-content: center;
      background: rgba(255,255,255, .85); z-index: 1000;
    }
    .loading-overlay.active { display: flex; }
    .loading-box {
      background: #fff; border: 1px solid #eee; border-radius: 12px;
      padding: 18px 22px; box-shadow: 0 12px 28px rgba(0,0,0,.08);
      max-width: 560px; width: 92%;
    }
    .loading-title { font-weight: 800; color: #1b1b1b; margin: 0 0 8px 0; }
    .loading-subtitle { color: #444; margin: 6px 0 8px 0; }
    .loading-details { color:#666; font-size: 13px; }
    .timer { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; color:#222; }

  </style>
</head>
<body>
  <div class="wrap">
    <h1>–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã User Story ‚Üí JM</h1>

    <div class="help">
      <div style="font-weight: 700; margin-bottom:6px;">–®–∞–≥–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</div>
      <ol>
        <li>–î–∞–π —Å—Å—ã–ª–∫—É –Ω–∞ –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª <b>(–≤–Ω–µ—à–Ω—é—é —Å—Å—ã–ª–∫—É)</b></li>
        <li>–í—ã–±–µ—Ä–∏ —Ç–∏–ø –≤—Ö–æ–¥–∞ ‚Üí <b>Xmind</b></li>
        <li>–ù–∞–∂–º–∏ <b>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</b></li>
        <li>–ñ–¥–∏ ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 5 –º–∏–Ω—É—Ç</li>
      </ol>
    </div>

    <div class="row">
      <div class="label">–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–∞–π–ª</div>
      <input id="fileLink" type="url" placeholder="https://github.com/.../file.xmind" style="width: 100%; padding: 10px; border: 1px solid #eee; border-radius: 8px;">
    </div>

    <div class="row">
      <div class="label">–í—Ö–æ–¥–Ω–æ–π —Ñ–æ—Ä–º–∞—Ç</div>
      <div class="xhr-row">
        <label style="display:inline-flex; align-items:center; gap:8px;">
          <input type="radio" name="format" value="xmind" checked> <span>Xmind</span>
        </label>
      </div>
    </div>

    <div class="row">
      <div class="label">–†–æ–ª–∏ (–º—É–ª—å—Ç–∏—è–∑—ã—á–Ω—ã–π –æ—Ç–≤–µ—Ç)</div>
      <div class="roles">
        <label><input type="checkbox" value="designer" checked disabled> <span>üß≠ Designer</span></label>
        <label><input type="checkbox" value="researcher" checked disabled> <span>üîé Researcher</span></label>
        <label><input type="checkbox" value="editor" checked disabled> <span>‚úçÔ∏è Editor</span></label>
      </div>
    </div>

    <div class="row">
      <div class="label">–Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–∞</div>
      <div class="xhr-row">
        <label><input type="radio" name="lang" value="AUTO" checked> –ê–≤—Ç–æ</label>
        <label><input type="radio" name="lang" value="RU"> –†—É—Å—Å–∫–∏–π</label>
        <label><input type="radio" name="lang" value="EN"> English</label>
        <label><input type="radio" name="lang" value="DE"> Deutsch</label>
        <label><input type="radio" name="lang" value="FR"> Fran√ßais</label>
        <label><input type="radio" name="lang" value="IT"> Italiano</label>
        <label><input type="radio" name="lang" value="ES"> Espa√±ol</label>
        <label><input type="radio" name="lang" value="PT"> Portugu√™s</label>
        <label><input type="radio" name="lang" value="BR"> Portugu√™s (BR)</label>
        <label><input type="radio" name="lang" value="TR"> T√ºrk√ße</label>
        <label><input type="radio" name="lang" value="PL"> Polski</label>
        <label><input type="radio" name="lang" value="CN"> ‰∏≠Êñá</label>
        <label><input type="radio" name="lang" value="TW"> Ê≠£È´î‰∏≠Êñá</label>
        <label><input type="radio" name="lang" value="HK"> È¶ôÊ∏Ø‰∏≠Êñá</label>
        <label><input type="radio" name="lang" value="JP"> Êó•Êú¨Ë™û</label>
        <label><input type="radio" name="lang" value="KR"> ÌïúÍµ≠Ïñ¥</label>
      </div>
    </div>

    <div class="row">
      <div class="btns">
        <button id="submit" class="btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button id="reset" class="btn-secondary">–°–±—Ä–æ—Å</button>
      </div>
    </div>

    <div class="divider"></div>

    <div class="row">
      <div class="label">–ñ—É—Ä–Ω–∞–ª</div>
      <div id="log">–ì–æ—Ç–æ–≤ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ. –í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å¬ª.</div>
      <div class="progress-bar"><div class="progress" id="progressBar"></div></div>
      <div class="small tips" style="margin-top:10px;">
        <div>–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫—É CORS / Failed to fetch ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ CORS –Ω–∞ –≤–µ–±—Ö—É–∫–µ –∏ –Ω–µ –¥–µ—Ä–∂–∏—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–æ–ª—å—à–µ 2‚Äì3 –º–∏–Ω—É—Ç </div>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-box">
      <div class="loading-title">–°–æ–∑–¥–∞—ë–º –∫–∞—Ä—Ç—É‚Ä¶</div>
      <div class="loading-subtitle">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç. –ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.</div>
      <div class="loading-details">
        <span id="loadingDetails">–ò–¥—ë—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞‚Ä¶</span>
        <div style="margin-top:6px;">–í—Ä–µ–º—è: <span class="timer" id="timer">00:00</span></div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const $ = (sel) => document.querySelector(sel);
    const submit = $('#submit');
    const reset = $('#reset');
    const logEl = $('#log');
    const overlay = $('#loadingOverlay');
    const loadingOverlay = overlay;
    const loadingDetails = $('#loadingDetails');
    const timerEl = $('#timer');
    const progress = $('#progressBar');

    let startTime = 0;
    let timerInterval = null;
    let currentMapId = null;

    function say(msg, color){
      const ts = new Date().toLocaleTimeString();
      logEl.innerHTML += `\\n[${ts}] ${msg}`;
      logEl.scrollTop = logEl.scrollHeight;
      if (color) logEl.style.color = color;
    }

    function startTimer(){
      timerEl.textContent = '00:00';
      startTime = Date.now();
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        const diff = Math.floor((Date.now() - startTime)/1000);
        const m = String(Math.floor(diff/60)).padStart(2, '0');
        const s = String(diff%60).padStart(2, '0');
        timerEl.textContent = `${m}:${s}`;
        const pct = Math.min(100, Math.floor((diff / (5*60)) * 100));
        progress.style.width = pct + '%';
      }, 1000);
    }

    function countryToLang(cc){
      const m = {
        RU:'ru', BY:'ru', KZ:'ru', UA:'uk',
        US:'en', GB:'en', CA:'en', AU:'en', NZ:'en', IE:'en', IN:'en', PH:'en', SG:'en',
        DE:'de', FR:'fr', IT:'it', ES:'es', PT:'pt', BR:'pt',
        TR:'tr', PL:'pl', CN:'zh', TW:'zh', HK:'zh', JP:'ja', KR:'ko'
      };
      return m[String(cc).toUpperCase()] || null;
    }

    function withTimeout(promise, ms){
      let t; const timeout = new Promise((_,rej)=> t=setTimeout(()=>rej(new Error('timeout')), ms));
      return Promise.race([promise.finally(()=>clearTimeout(t)), timeout]);
    }

// === –ü–ê–†–ê–ú–ï–¢–†–´ –û–ü–†–û–°–ê –í–¢–û–†–û–ì–û –í–ï–ë–•–£–ö–ê ===
const FIRST_DELAY_MS   = 120000; // 2 –º–∏–Ω—É—Ç—ã –¥–æ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
const POLL_INTERVAL_MS = 15000;  // –∑–∞—Ç–µ–º –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫
const REQ_TIMEOUT_MS   = 25000;  // —Ç–∞–π–º–∞—É—Ç –æ–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

function startPollingGetMap(mapId, firstDelayMs = FIRST_DELAY_MS, intervalMs = POLL_INTERVAL_MS) {
  let pollTimer = null;

  async function once() {
    if (typeof startTime === 'number' && window.loadingDetails) {
      const sec = Math.floor((Date.now() - startTime) / 1000);
      loadingDetails.textContent = `–ü—Ä–æ—à–ª–æ ${sec} —Å–µ–∫. ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—Ä—Ç—É...`;
    }
    const controller = new AbortController();
    const kill = setTimeout(() => controller.abort(), REQ_TIMEOUT_MS);
    try {
      const resp = await fetch('https://n8n.sotiio.com/webhook/getmap', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({ map_id: mapId }),
        signal: controller.signal
      });
      clearTimeout(kill);

      if (resp.status === 204) return;
      if (!resp.ok) { console.warn('getmap HTTP', resp.status); return; }

      const text = await resp.text();
      if (!text) return;

      const data = JSON.parse(text);
      if (data && data.status === 'pending') return;

      const nodeTree = Array.isArray(data) ? data[0] : data;
      if (nodeTree && nodeTree.format === 'node_tree' && nodeTree.data) {
        clearInterval(pollTimer);
        clearInterval(timerInterval);
        loadingOverlay.classList.remove('active');

        if (window.parent && window.parent !== window) {
          if (window.parent.UI && typeof window.parent.UI.closeUserStory === 'function') {
            window.parent.UI.closeUserStory();
            setTimeout(() => {
              window.parent.postMessage({ type: 'map:set', payload: nodeTree }, '*');
            }, 400);
          } else {
            window.parent.postMessage({ type: 'map:set', payload: nodeTree }, '*');
          }
        }
      }
    } catch (e) {
      console.warn('poll error:', e.message || e);
    }
  }

  setTimeout(() => {
    once();
    pollTimer = setInterval(once, intervalMs);
  }, firstDelayMs);
}

    async function detectLanguageAuto(){
      try {
        // 1) –ø–æ–ø—ã—Ç–∫–∞ –ø–æ IP
        const resp = await withTimeout(fetch('https://ipapi.co/json/', {cache:'no-store'}), 2000);
        const ip = await resp.json();
        const lng = countryToLang(ip && ip.country ? ip.country : 'US');
        return lng || 'en';
      } catch {
        // 2) fallback: –±—Ä–∞—É–∑–µ—Ä–Ω—ã–π —è–∑—ã–∫
        const nav = navigator.language || 'en';
        return (nav || 'en').slice(0,2).toLowerCase();
      }
    }

    function languageMap(){
      return {
        'ru':'RU', 'uk':'RU',
        'en':'EN',
        'de':'DE', 'fr':'FR', 'it':'IT', 'es':'ES', 'pt':'PT', 'pl':'PL', 'tr':'TR',
        'zh':'CN', 'ja':'JP', 'ko':'KR'
      };
    }

    function getSelectedLang(){
      const checked = document.querySelector('input[name="lang"]:checked');
      return checked ? checked.value : 'AUTO';
    }

    function normalizeLangCode(code){
      const s = String(code || '').toUpperCase();
      const known = ['AUTO','RU','EN','DE','FR','IT','ES','PT','BR','TR','PL','CN','TW','HK','JP','KR'];
      if (!known.includes(s)) return 'AUTO';
      return s;
    }

    function resolveReplyLang(){
      const pick = getSelectedLang();
      if (pick === 'AUTO') return 'AUTO';
      if (pick === 'BR') return 'PT';
      if (['CN','TW','HK'].includes(pick)) return 'CN';
      return pick;
    }

    function resolveLanguageReply(){
      const pick = getSelectedLang();
      if (pick === 'AUTO') return 'AUTO';
      return pick;
    }

    reset.addEventListener('click', () => {
      $('#fileLink').value = '';
      say('–ü–æ–ª—è –æ—á–∏—â–µ–Ω—ã');
    });

    submit.addEventListener('click', async () => {
      const fileUrl = $('#fileLink').value.trim();
      if (!fileUrl) { say('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–∞–π–ª', 'crimson'); return; }

      submit.disabled = true;
      startTimer();
      loadingOverlay.classList.add('active');
      loadingDetails.textContent = '–ì–æ—Ç–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä‚Ä¶';

      const selected = document.querySelector('input[name="format"]:checked')?.value || 'xmind';
      const langChoice = normalizeLangCode(getSelectedLang());
      const language_reply = normalizeLangCode(resolveLanguageReply());
      let answer_lang = 'EN';

      if (langChoice === 'AUTO') {
        try {
          const auto = await detectLanguageAuto();
          const map = languageMap();
          answer_lang = map[auto] || 'EN';
          say(`–ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞: ${auto} ‚Üí ${answer_lang}`);
        } catch {
          answer_lang = 'EN';
        }
      } else {
        answer_lang = langChoice === 'BR' ? 'PT' : (['CN','TW','HK'].includes(langChoice) ? 'CN' : langChoice);
      }

      const uid = Math.random().toString(36).slice(2).toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,8);
      currentMapId = `US-${uid}`;

      const payload = {
        map_id: currentMapId,
        link: fileUrl,
        mode: selected,
        answer_lang,
        language_reply
      };

      say(`–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (/us): map_id=${currentMapId}, format=${selected}, answer_lang=${answer_lang}, language_reply=${language_reply}`);
      loadingDetails.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã‚Ä¶';

      fetch('https://n8n.sotiio.com/webhook/us', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(response => {
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.text().then(text => {
          try { return text ? JSON.parse(text) : {}; }
          catch { throw new Error('–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞'); }
        });
      })
      .then(data => {
        say('–ó–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ.');
        loadingDetails.textContent = '–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω...';
      })
      .catch((error) => {
        console.warn('–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ:', error);
      })
      .finally(() => {
        // 2. –ñ–¥—ë–º 5 —Å–µ–∫—É–Ω–¥ –∏ –¥–µ–ª–∞–µ–º –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –∑–∞ –∫–∞—Ä—Ç–æ–π
        startPollingGetMap(currentMapId);
      });
    });

    // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
    window.addEventListener('beforeunload', () => {
      if (timerInterval) clearInterval(timerInterval);
    });
  })();
  </script>
</body>
</html>
