<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>sotiio map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/style/jsmind.css" />
  <style>
    html, body { 
      height: 100%; 
      margin: 0; 
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }
    
    #wrap { 
      height: 100vh; 
      display: grid;
      grid-template-columns: 1fr;
      position: relative;
    }
    
    #jsmind_container { 
      height: 100%; 
      width: 100%;
      background: #ece0d1 !important;
      position: relative;
      overflow: visible;
    }

    /* === –ö–æ—Ñ–µ–π–Ω–∞—è –ø–∞–ª–∏—Ç—Ä–∞ === */
    :root {
      --bg: #ece0d1;
      --lvl0: #dbc1ac; /* root */
      --lvl1: #967259; /* level 2 */
      --lvl2: #634832; /* level 3 */
      --lvl3: #38220f; /* level 4 */
      --sel:  #ff622b; /* selected */
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —É–∑–ª–æ–≤ */
    jmnode {
      border-radius: 10px !important;
      border: 1px solid rgba(0,0,0,.10) !important;
      box-shadow: 0 2px 4px rgba(0,0,0,.10) !important;
      font-family: inherit;
    }

    jmnode.jsmind-root { 
      background: var(--lvl0) !important; 
      color: #1f1f1f !important; 
      font-size: 20px !important;
    }
    
    jmnode.lvl-1 { 
      background: var(--lvl1) !important; 
      color: #fff !important; 
    }
    
    jmnode.lvl-2 { 
      background: var(--lvl2) !important; 
      color: #fff !important; 
    }
    
    jmnode.lvl-3 { 
      background: var(--lvl3) !important; 
      color: #fff !important; 
    }

    jmnode.selected { 
      background: var(--sel) !important; 
      border-color: var(--sel) !important; 
      color: #fff !important; 
      outline: none !important;
    }

    /* === Drawer (–ø—Ä–∞–≤—ã–π –≤—ã–µ–∑–∂–∞—é—â–∏–π, 40% —à–∏—Ä–∏–Ω—ã) === */
    #drawer{
      position: fixed; 
      right: 0; 
      top: 0; 
      height: 100vh;
      width: 40vw; 
      max-width: 880px; 
      min-width: 320px;
      background: #ece6df !important;
      color: #131313 !important;
      z-index: 9999;
      box-shadow: -12px 0 32px rgba(0,0,0,.18), -1px 0 0 rgba(0,0,0,.08);
      transform: translateX(100%); 
      transition: transform .25s ease;
      display: flex; 
      flex-direction: column; 
      overflow: hidden;
      border-left: 1px solid rgba(0,0,0,.08);
      font-family: inherit;
    }
    
    #drawer.open{ 
      transform: translateX(0); 
    }

    /* –í–∫–ª–∞–¥–∫–∏ */
    .dw-tabs{display:flex;background:#f7f7f7;border-bottom:1px solid #eee}
    .dw-tab{flex:1;padding:12px 10px;text-align:center;cursor:pointer;border:0;background:transparent;font-weight:500;color:#666;border-bottom:2px solid transparent}
    .dw-tab.active{background:#ece6df;border-bottom:2px solid #ff622b;color:#111}
    .dw-body{padding:12px 16px;overflow:auto;height:100%}
    .tab-content{display:none}.tab-content.active{display:block}
    pre{margin:0;padding:12px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;white-space:pre-wrap;word-break:break-word;font:12px/1.45 ui-monospace,Menlo,Consolas,monospace}
    table.meta{width:100%;border-collapse:collapse;background:#fff;border:1px solid #e5e7eb;border-radius:10px;overflow:hidden;margin-bottom:12px}
    table.meta th,table.meta td{padding:10px 12px;border-bottom:1px solid #eee;font-size:14px}
    table.meta th{width:30%;background:#fafafa;text-align:left;color:#444}
    .wiki-item{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;margin:0 0 10px}
    .wiki-item h3{margin:0 0 6px;font-size:15px;color:#222}
    .wiki-item div{font-size:14px;color:#333;line-height:1.4}
    .empty{color:#777;font-style:italic;padding:16px 0}

    /* === –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –æ–ø—Ä–æ—Å–∞ === */
    #sotiio_modal, #sotiio_modal * { box-sizing: border-box; }
    #sotiio_survey_btn{
      position: fixed; right: 20px; bottom: 24px; z-index:11000;
      background: var(--sel,#ff622b); color:#fff; border:none; padding:12px 16px;
      border-radius:12px; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.18);
      font-weight:600; font-family:inherit;
    }
    #sotiio_modal{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      z-index:11010; background: rgba(0,0,0,0.45); padding:16px; overflow-x:hidden;
    }
    #sotiio_modal .card{
      width:min(820px,96vw); max-height:90vh; overflow:auto; background:#fff;
      border-radius:12px; padding:18px 22px; box-shadow:0 12px 40px rgba(0,0,0,.22);
      font-family:inherit; position:relative; overflow-x:hidden;
    }
    .close-btn{
      position:absolute; top:10px; right:12px; font-size:24px; font-weight:800;
      line-height:1; border:none; background:transparent; cursor:pointer; color:#444;
    }
    .close-btn:hover{ color:#000; transform:scale(1.06); }
    .row{ margin:14px 0; }
    .label{ font-weight:700; margin-bottom:8px; }
    .roles{ display:flex; flex-direction:column; gap:8px; }
    .roles label{ display:flex; align-items:center; gap:10px; font-size:15px; }
    .narrow{ width:60%; min-width:300px; margin-inline:auto; }
    .narrow-left{ width:60%; max-width:640px; margin-left:0; margin-right:auto; }
    .text-input{
      width:100%; padding:12px 14px; border-radius:10px; border:1px solid #ddd; font-size:15px;
    }
    .options-grid{ display:grid; grid-template-columns:repeat(2,minmax(240px,1fr)); gap:10px; }
    .option-card{
      border:1px solid #e6e6e6; padding:10px 12px; border-radius:10px;
      cursor:pointer; user-select:none; background:#fff; font-size:14px;
    }
    .option-card.selected{ border-color:var(--sel,#ff622b); background:rgba(255,98,43,0.06); }
    .add-own.narrow-left{ position:relative; }
    .add-own .text-input{ padding-right:46px; }
    .add-own .add-btn{
      position:absolute; right:6px; top:50%; transform:translateY(-50%);
      height:34px; min-width:34px; padding:0 10px;
      background:#f7f7f7; border:1px solid #ddd; border-radius:8px; cursor:pointer;
      display:flex; align-items:center; justify-content:center; font-size:16px;
    }
    .add-own .add-btn:hover{ background:#ececec; }
    .chiplist{ display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
    .chip{ background:#f3f4f6; border:1px solid #e5e7eb; padding:6px 10px; border-radius:16px; font-size:13px; }
    .actions{ display:flex; justify-content:flex-end; align-items:center; margin-top:16px; gap:10px; }
    .primary-btn{
      background:var(--sel,#ff622b); color:#fff; border:none; padding:10px 16px;
      border-radius:10px; cursor:pointer; font-weight:600;
    }
    .muted{ font-size:13px; color:#666; }
    .divider{
      height:1px; background:rgba(0,0,0,0.05); border:0; margin:16px 0; width:100%;
    }
    @media (max-width: 640px){
      #sotiio_modal .card{ width:100%; height:auto; max-height:88vh; padding:16px; border-radius:12px; }
      .options-grid{ grid-template-columns:1fr; }
      .roles label{ font-size:16px; }
      .text-input{ font-size:16px; }
      .narrow, .narrow-left{ width:100%; min-width:0; max-width:none; }
      #sotiio_survey_btn{ right:16px; bottom:18px; }
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 12000;
      flex-direction: column;
      gap: 16px;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--sel, #ff622b);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .loading-text {
      font-size: 16px;
      color: #333;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
<div id="wrap">
  <div id="jsmind_container"></div>

  <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-spinner"></div>
    <div class="loading-text">–°–æ–∑–¥–∞—ë–º –∫–∞—Ä—Ç—É –∑–Ω–∞–Ω–∏–π...</div>
  </div>

  <aside id="drawer" aria-hidden="true">
    <div class="dw-tabs">
      <button class="dw-tab" data-tab="wiki">Wiki</button>
      <button class="dw-tab active" data-tab="meta">Meta</button>
      <button class="dw-tab" data-tab="links">Links</button>
      <button class="dw-tab" data-tab="raw">Raw Data</button>
    </div>
    <div class="dw-body">
      <div id="tab-wiki" class="tab-content"><div class="empty">–î–ª—è —ç—Ç–æ–≥–æ —É–∑–ª–∞ –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ Wiki.</div></div>
      <div id="tab-meta" class="tab-content active"><div class="empty">–ù–µ—Ç –º–µ—Ç–∞-–¥–∞–Ω–Ω—ã—Ö.</div></div>
      <div id="tab-links" class="tab-content"><div class="empty">–ü—É—Å—Ç–æ.</div></div>
      <div id="tab-raw" class="tab-content"><pre id="raw-pre">–í—ã–¥–µ–ª–∏ —É–∑–µ–ª ‚Äî –∑–¥–µ—Å—å –ø–æ–∫–∞–∂–µ—Ç—Å—è node.data</pre></div>
    </div>
  </aside>
</div>

<!-- –§–æ—Ä–º–∞ –æ–ø—Ä–æ—Å–∞ -->
<button id="sotiio_survey_btn" title="–ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã">üß≠ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã</button>
<div id="sotiio_modal" role="dialog" aria-hidden="true">
  <div class="card" role="document" aria-modal="true">
    <button class="close-btn" id="sotiio_close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>
    <div class="row">
      <div class="label">–Ø –∫–∞–∫‚Ä¶</div>
      <div class="roles narrow-left">
        <label><input type="radio" name="role" value="Novice"> –ù–æ–≤–∏—á–æ–∫</label>
        <label><input type="radio" name="role" value="Enthusiast"> –£–≤–ª–µ–∫–∞—é—â–∏–π—Å—è</label>
        <label><input type="radio" name="role" value="Geek"> –ì–∏–∫</label>
        <label><input type="radio" name="role" value="Pro"> –ü—Ä–æ—Ñ–∏</label>
      </div>
    </div>
    <div class="divider"></div>
    <div class="row">
      <div class="label">–•–æ—á—É –∏–∑—É—á–∏—Ç—å‚Ä¶</div>
      <div class="narrow-left">
        <input id="sotiio_subject" class="text-input"
               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–∏–Ω–æ–≤—Å–µ–ª–µ–Ω–Ω—É—é Marvel, –º–∏—Ä –∫—Ä–∏–ø—Ç–æ-–∞–∫—Ç–∏–≤–æ–≤, –≠–≤–æ–ª—é—Ü–∏—é —á–µ–ª–æ–≤–µ–∫–∞‚Ä¶">
        <div class="muted" style="margin-top:6px">–£–∫–∞–∂–∏—Ç–µ –ª—é–±—É—é –≤—Å–µ–ª–µ–Ω–Ω—É—é –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è.</div>
      </div>
    </div>
    <div class="divider"></div>
    <div class="row">
      <div class="label">–ß—Ç–æ–±—ã‚Ä¶</div>
      <div id="sotiio_options" class="options-grid"></div>
      <div class="add-own narrow-left" style="margin-top:10px;">
        <input id="sotiio_own" class="text-input" placeholder="–ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ —Å–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ Enter">
        <button class="add-btn" id="sotiio_add_own" title="–î–æ–±–∞–≤–∏—Ç—å">Ôºã</button>
      </div>
      <div id="sotiio_selected_chips" class="chiplist narrow"></div>
    </div>
    <div class="actions">
      <div class="muted" id="sotiio_feedback"></div>
      <button id="sotiio_submit" class="primary-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<script src="/static/js/jsmind.js"></script>
<script>
(function(){
  const qs=new URLSearchParams(location.search);
  const task_id=qs.get('task');
  const filename=qs.get('name');

  const jm=new jsMind({
    container:'jsmind_container',
    editable:false, support_html:true,
    view:{hmargin:140, vmargin:30, line_style:'curved'},
    layout:{hspace:80, vspace:20, pspace:10, direction:'right'}
  });

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª–∞—Å—Å–æ–≤ —É—Ä–æ–≤–Ω–µ–π
  function tagLevels() {
    const root = jm.get_root();
    if (!root) return;
    
    const walk = (node, level) => {
      const el = document.querySelector(`.jmnode[nodeid="${node.id}"]`);
      if (el) {
        el.classList.remove('lvl-0', 'lvl-1', 'lvl-2', 'lvl-3');
        if (level === 0) {
          el.classList.add('jsmind-root');
        } else {
          el.classList.add('lvl-' + Math.min(level, 3));
        }
      }
      
      if (node.children) {
        node.children.forEach(child => walk(child, level + 1));
      }
    };
    
    walk(root, 0);
  }

  function renderMeta(node){
    const box=document.getElementById('tab-meta');
    const d=node?.data?.data || node?.data || {};
    const rows=[
      ['ID', d.node_id || d.id || '‚Äî'],
      ['–ù–∞–∑–≤–∞–Ω–∏–µ', d.label || d.topic || '‚Äî'],
      ['–£—Ä–æ–≤–µ–Ω—å', d.level || (d.node_id && d.node_id.startsWith('L1') ? '–ö–æ—Ä–Ω–µ–≤–æ–π':'–î–æ—á–µ—Ä–Ω–∏–π') || '‚Äî'],
    ];
    const meta= d.meta && typeof d.meta==='object' ? d.meta : {};
    const pre=JSON.stringify(meta,null,2);
    box.innerHTML=`<table class="meta"><tbody>
      ${rows.map(r=>`<tr><th>${r[0]}</th><td>${r[1]}</td></tr>`).join('')}
      </tbody></table>
      <div class="empty">–ú–µ—Ç–∞-–¥–∞–Ω–Ω—ã–µ</div><pre>${pre}</pre>`;
  }

  function renderWiki(node){
    const box=document.getElementById('tab-wiki');
    const d=node?.data?.data || node?.data || {};
    const meta=d.meta;
    if(!meta||typeof meta!=='object'){ box.innerHTML='<div class="empty">–î–ª—è —ç—Ç–æ–≥–æ —É–∑–ª–∞ –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ Wiki.</div>'; return; }
    const inner=(meta.meta && typeof meta.meta==='object')? meta.meta:{};
    const piles=[inner.text,inner.number,inner.select,inner.checkbox,inner.date,
      meta.meta_text,meta.meta_number,meta.meta_select,meta.meta_checkbox,meta.meta_date].filter(Array.isArray);
    const items=[];
    for(const arr of piles){for(const it of arr){if(it&&typeof it==='object'){items.push({n:it.name??'',v:it.value??''})}}}
    if(!items.length){box.innerHTML='<div class="empty">–î–ª—è —ç—Ç–æ–≥–æ —É–∑–ª–∞ –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ Wiki.</div>';return;}
    box.innerHTML=items.map(({n,v})=>
      `<div class="wiki-item"><h3>${escapeHtml(n)}</h3><div>${escapeHtml(v)}</div></div>`
    ).join('');
  }

  function renderRaw(node){
    const pre=document.getElementById('raw-pre');
    let txt='null'; try{ txt=JSON.stringify(node?.data??null,null,2);}catch(e){txt=String(node?.data);}
    pre.textContent=txt;
  }

  function escapeHtml(s){return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;")}

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
  function showLoading() {
    document.getElementById('loadingOverlay').classList.remove('hidden');
  }
  
  function hideLoading() {
    document.getElementById('loadingOverlay').classList.add('hidden');
  }

  function displayMindData(mindData) {
    try {
      jm.clear();
      jm.show(mindData);
      jm.collapse_all();
      const root = jm.get_root();
      if (root) jm.expand_node(root.id);
      
      setTimeout(() => {
        tagLevels();
        jm.resize();
      }, 100);
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –∫–∞—Ä—Ç—ã:', error);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –∫–∞—Ä—Ç—ã –∑–Ω–∞–Ω–∏–π');
    }
  }

  (function initDrawer(){
    const cont=document.getElementById('jsmind_container');
    const drawer=document.getElementById('drawer');
    let last=null;
    document.querySelectorAll('.dw-tab').forEach(t=>{
      t.addEventListener('click',()=>{
        const id=t.getAttribute('data-tab');
        document.querySelectorAll('.dw-tab').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
        t.classList.add('active'); document.getElementById('tab-'+id).classList.add('active');
      });
    });
    function open(node,el){
      if(last) last.classList.remove('selected');
      if(el){el.classList.add('selected');last=el;}
      renderMeta(node);renderWiki(node);renderRaw(node);
      drawer.classList.add('open');drawer.setAttribute('aria-hidden','false');
    }
    function close(){drawer.classList.remove('open');drawer.setAttribute('aria-hidden','true');if(last)last.classList.remove('selected');last=null;}
    cont.addEventListener('click',e=>{const el=e.target.closest('jmnode');if(!el){close();return;}const node=jm.get_node(el.getAttribute('nodeid'));if(node)open(node,el);});
    document.addEventListener('click',e=>{if(!drawer.contains(e.target)&&!e.target.closest('jmnode'))close();});
    document.addEventListener('keydown',e=>{if(e.key==='Escape')close();});
  })();

  async function main(){
    if (task_id && filename) {
      showLoading();
      try {
        const url=`/download_files_pyrus?task_id=${encodeURIComponent(task_id)}&filename=${encodeURIComponent(filename)}&match_mode=exact&versions=latest`;
        const res=await fetch(url); const raw=await res.json();
        const conv=await fetch('/json_2_jm',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(raw)});
        const mind=await conv.json();
        jm.show(mind); jm.collapse_all(); const root=jm.get_root(); if(root) jm.expand_node(root.id);
        
        setTimeout(() => {
          tagLevels();
          jm.resize();
        }, 100);
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
      } finally {
        hideLoading();
      }
    }
    window.addEventListener('resize',()=>{jm.resize();});
  }

  // === –õ–û–ì–ò–ö–ê –§–û–†–ú–´ –û–ü–†–û–°–ê ===
  const roleTexts = {
    "Novice": [
      "–ë—ã—Å—Ç—Ä–æ —Å–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ —Ç–µ–º–µ –∏ –Ω–µ —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Å–µ–±—è –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–º",
      "–ü–æ–Ω–∏–º–∞—Ç—å, –æ —á—ë–º –≥–æ–≤–æ—Ä—è—Ç –¥—Ä—É–≥–∏–µ, –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –±–∞–∑–æ–≤—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä",
      "–û—Ç–ª–∏—á–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ –ø–æ–Ω—è—Ç–∏—è –æ—Ç –≤—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã—Ö –∏ –Ω–µ —Ç—Ä–∞—Ç–∏—Ç—å –≤—Ä–µ–º—è –∑—Ä—è",
      "–ò–º–µ—Ç—å –Ω–∞–¥—ë–∂–Ω—É—é ¬´—à–ø–∞—Ä–≥–∞–ª–∫—É¬ª –ø–æ –æ—Å–Ω–æ–≤–∞–º",
      "–ü–æ–Ω—è—Ç—å, –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞ –ª–∏ —Ç–µ–º–∞ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —É–≥–ª—É–±–ª–µ–Ω–∏—è",
      "–ò–∑–±–µ–∂–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω—ã—Ö –æ—à–∏–±–æ–∫ –∏ –Ω–µ–ª–æ–≤–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏–π",
      "–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç—å –ª—é–±–æ–ø—ã—Ç—Å—Ç–≤–æ –∏ –ø–æ–ª—É—á–∏—Ç—å –æ–±—â–∏–π –æ–±–∑–æ—Ä",
      "–ü–æ–Ω—è—Ç—å, –∫–∞–∫ —ç—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω—å—é –∏ –≥–¥–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è",
      "–ë—ã—Ç—å –≤ –∫—É—Ä—Å–µ —Ç–µ–∫—É—â–∏—Ö —Ç—Ä–µ–Ω–¥–æ–≤ –∏ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç–µ–º",
      "–£–ø–æ—Ä—è–¥–æ—á–∏—Ç—å –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞–Ω–∏—è –∏ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å"
    ],
    "Enthusiast": [
      "–†–∞–∑–æ–±—Ä–∞—Ç—å—Å—è, –∫–∞–∫ –≤—Å—ë —É—Å—Ç—Ä–æ–µ–Ω–æ –≤–Ω—É—Ç—Ä–∏, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –∑–Ω–∞—Ç—å —Ñ–∞–∫—Ç—ã",
      "–í–∏–¥–µ—Ç—å –ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Å–≤—è–∑–∏ –º–µ–∂–¥—É —á–∞—Å—Ç—è–º–∏ —Å–∏—Å—Ç–µ–º—ã",
      "–£–º–µ—Ç—å –ø—Ä–æ—Å—Ç–æ –∏ —è—Å–Ω–æ –æ–±—ä—è—Å–Ω—è—Ç—å —Å–ª–æ–∂–Ω—ã–µ –≤–µ—â–∏ –¥—Ä—É–≥–∏–º",
      "–ù–∞—á–∞—Ç—å –ø—Ä–∏–º–µ–Ω—è—Ç—å –∑–Ω–∞–Ω–∏—è –≤ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π –∂–∏–∑–Ω–∏ –∏–ª–∏ —Ä–∞–±–æ—Ç–µ",
      "–ù–∞—É—á–∏—Ç—å—Å—è —Ä–∞—Å—Å—É–∂–¥–∞—Ç—å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –∏ –¥–µ–ª–∞—Ç—å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ –≤—ã–≤–æ–¥—ã",
      "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–Ω–∞–Ω–∏—è –∏ –ø–æ–Ω—è—Ç—å, —á—Ç–æ –∏–∑—É—á–∞—Ç—å –¥–∞–ª—å—à–µ",
      "–í–∏–¥–µ—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É: –∏—Å—Ç–æ—Ä–∏—é –∏ –≤–æ–∑–º–æ–∂–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ",
      "–°—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É —Å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞–º–∏ –∏ –≤–∏–¥–µ—Ç—å —Å–∏–ª—å–Ω—ã–µ –∏ —Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã",
      "–ü–æ–ª—É—á–∞—Ç—å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ –æ—Ç –æ—Å–≤–æ–µ–Ω–∏—è —Å–ª–æ–∂–Ω–æ–≥–æ",
      "–ü—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å —Ö–∞–æ—Å —Ä–∞–∑—Ä–æ–∑–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–∫—Ç–æ–≤ –≤ —Å—Ç—Ä–æ–π–Ω—É—é —Å–∏—Å—Ç–µ–º—É"
    ],
    "Geek": [
      "–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ —Ç–µ—Ö–Ω–∏–∫–∏ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á",
      "–ü–æ–ª—É—á–∞—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ –∑–∞ —Å—á—ë—Ç –≥–ª—É–±–æ–∫–∏—Ö –∑–Ω–∞–Ω–∏–π",
      "–°—Ç–∞—Ç—å –ø—Ä–∏–∑–Ω–∞–Ω–Ω—ã–º —ç–∫—Å–ø–µ—Ä—Ç–æ–º, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –æ–±—Ä–∞—â–∞—é—Ç—Å—è –∑–∞ —Å–æ–≤–µ—Ç–æ–º",
      "–ù–∞—Ö–æ–¥–∏—Ç—å –∏ –ø—Ä–∏–º–µ–Ω—è—Ç—å –ª—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞",
      "–ú–æ–Ω–µ—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–Ω–∞–Ω–∏—è –∏ –Ω–∞–≤—ã–∫–∏ –≤ —ç—Ç–æ–π –æ–±–ª–∞—Å—Ç–∏",
      "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –æ—Ü–µ–Ω–∏–≤–∞—Ç—å —Ä–µ—à–µ–Ω–∏—è, –Ω–∞—Ö–æ–¥—è —Å–ª–∞–±—ã–µ –º–µ—Å—Ç–∞ –∏ —É—è–∑–≤–∏–º–æ—Å—Ç–∏",
      "–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –æ–±—É—á–∞—Ç—å –∏ –Ω–∞—Å—Ç–∞–≤–ª—è—Ç—å –¥—Ä—É–≥–∏—Ö, –ø–µ—Ä–µ–¥–∞–≤–∞—è –æ–ø—ã—Ç",
      "–ü—Ä–∏–Ω–∏–º–∞—Ç—å –ø—Ä–æ–¥—É–º–∞–Ω–Ω—ã–µ —Ç–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏",
      "–ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã –ø–æ–¥ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏",
      "–£–≤–µ—Ä–µ–Ω–Ω–æ –ø–æ–±–µ–∂–¥–∞—Ç—å –≤ –¥–∏—Å–∫—É—Å—Å–∏—è—Ö, –æ–ø–∏—Ä–∞—è—Å—å –Ω–∞ —Ñ–∞–∫—Ç—ã"
    ],
    "Pro": [
      "–í–∏–¥–µ—Ç—å —Å–∏—Å—Ç–µ–º—É —Ü–µ–ª–∏–∫–æ–º –∏ –∑–∞–¥–∞–≤–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –µ—ë —Ä–∞–∑–≤–∏—Ç–∏—è",
      "–°–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏, —Å–∏—Å—Ç–µ–º—ã –∏ –ø—Ä–æ–¥—É–∫—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞",
      "–ù–∞—Ö–æ–¥–∏—Ç—å ¬´–±–µ–ª—ã–µ –ø—è—Ç–Ω–∞¬ª –∏ —Ç–æ—á–∫–∏ –ø—Ä–æ—Ä—ã–≤–∞ –¥–ª—è –∏–Ω–Ω–æ–≤–∞—Ü–∏–π",
      "–ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã —Å –Ω—É–ª—è, –ø–æ–Ω–∏–º–∞—è –∏—Ö —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã",
      "–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–∏—Å—Ç–µ–º—ã, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å",
      "–ü—Ä–∏–Ω–∏–º–∞—Ç—å –≤–∑–≤–µ—à–µ–Ω–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è —Å –≤—ã—Å–æ–∫–æ–π —Ü–µ–Ω–æ–π –æ—à–∏–±–∫–∏",
      "–§–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –≤–∏–¥–µ–Ω–∏–µ –±—É–¥—É—â–µ–≥–æ –∏ –≤–µ—Å—Ç–∏ –∑–∞ —Å–æ–±–æ–π –∫–æ–º–∞–Ω–¥—É –∏–ª–∏ –æ—Ç—Ä–∞—Å–ª—å",
      "–í—ã—Å—Ç—É–ø–∞—Ç—å –º—ã—Å–ª–∏—Ç–µ–ª—å–Ω—ã–º –ª–∏–¥–µ—Ä–æ–º, –≤–ª–∏—è—è –Ω–∞ —Ä–∞–∑–≤–∏—Ç–∏–µ –∏–Ω–¥—É—Å—Ç—Ä–∏–∏",
      "–û—Å—Ç–∞–≤–ª—è—Ç—å –∑–Ω–∞—á–∏–º—ã–π —Å–ª–µ–¥ –∏ –≤–Ω–æ—Å–∏—Ç—å —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –≤–∫–ª–∞–¥ –≤ –æ–±–ª–∞—Å—Ç—å",
      "–í–∏–¥–µ—Ç—å —Å–∫—Ä—ã—Ç—ã–µ —Ä—ã—á–∞–≥–∏ –≤–ª–∏—è–Ω–∏—è –∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞—Ç—å –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è"
    ]
  };

  const btn = document.getElementById('sotiio_survey_btn');
  const modal = document.getElementById('sotiio_modal');
  const closeBtn = document.getElementById('sotiio_close');
  const optionsBox = document.getElementById('sotiio_options');
  const feedback = document.getElementById('sotiio_feedback');
  const submitBtn = document.getElementById('sotiio_submit');
  const ownInput = document.getElementById('sotiio_own');
  const addOwnBtn = document.getElementById('sotiio_add_own');
  const chips = document.getElementById('sotiio_selected_chips');

  function open(){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); feedback.textContent=''; document.body.style.overflow='hidden'; }
  function close(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); clear(); document.body.style.overflow=''; }
  function clear(){
    document.querySelectorAll('input[name="role"]').forEach(r=>r.checked=false);
    document.getElementById('sotiio_subject').value='';
    optionsBox.innerHTML='';
    chips.innerHTML='';
    ownInput.value='';
  }

  document.querySelectorAll('input[name="role"]').forEach(r=>{
    r.addEventListener('change', ()=>{
      const role = document.querySelector('input[name="role"]:checked')?.value;
      optionsBox.innerHTML='';
      const list = roleTexts[role] || [];
      for(const v of list){
        const div = document.createElement('div');
        div.className='option-card';
        div.textContent = v;
        div.dataset.value = v;
        optionsBox.appendChild(div);
      }
      syncChips();
    });
  });

  optionsBox.addEventListener('click', e=>{
    const card = e.target.closest('.option-card'); if(!card) return;
    card.classList.toggle('selected'); syncChips();
  });

  function syncChips(){
    chips.innerHTML='';
    const selected = Array.from(optionsBox.querySelectorAll('.option-card.selected')).map(x=>x.dataset.value);
    for(const s of selected){
      const c = document.createElement('span'); c.className='chip'; c.textContent = s; chips.appendChild(c);
    }
  }

  function addOwn(){
    const val = ownInput.value.trim(); if(!val) return;
    let existing = Array.from(optionsBox.children).find(x=>x.dataset.value===val);
    if(!existing){
      const div = document.createElement('div');
      div.className='option-card selected'; div.textContent = val; div.dataset.value = val; optionsBox.prepend(div);
    }else{ existing.classList.add('selected'); }
    ownInput.value=''; syncChips();
  }
  ownInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); addOwn(); }});
  addOwnBtn.addEventListener('click', addOwn);

  function two(n){ return String(n).padStart(2,'0'); }
  function mapIdFromNow(){
    const d = new Date();
    const ss = two(d.getSeconds());
    const mm = two(d.getMinutes());
    const hh = two(d.getHours());
    const dd = two(d.getDate());
    const MM = two(d.getMonth()+1);
    const yy = two(d.getFullYear()%100);
    return `${ss}${mm}${hh}${dd}${MM}${yy}`;
  }

  // –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏
  submitBtn.addEventListener('click', async ()=>{
    const role = document.querySelector('input[name="role"]:checked')?.value;
    const subject = document.getElementById('sotiio_subject').value.trim();
    const chosen = Array.from(optionsBox.querySelectorAll('.option-card.selected')).map(x=>x.dataset.value);

    if(!role){ feedback.style.color='crimson'; feedback.textContent='–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å.'; return; }
    if(!subject){ feedback.style.color='crimson'; feedback.textContent='–£–∫–∞–∂–∏—Ç–µ —Ç–µ–º—É/–≤—Å–µ–ª–µ–Ω–Ω—É—é.'; return; }
    if(chosen.length===0){ feedback.style.color='crimson'; feedback.textContent='–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç –≤ ¬´–ß—Ç–æ–±—ã‚Ä¶¬ª –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–π.'; return; }

    const map_id = mapIdFromNow();

    feedback.style.color='#333'; feedback.textContent='–û—Ç–ø—Ä–∞–≤–ª—è–µ–º‚Ä¶';
    showLoading();
    
    try{
      const payload = {
        source: 'sotiio_web_survey',
        map_id,
        user_story: {
          "I_as...": role,
          "Want_to_discover_a_universe...": subject,
          "So_that...": chosen,
          timestamp: (new Date()).toISOString()
        }
      };

      const resp = await fetch('https://n8n.sotiio.com/webhook/us', {
        method:'POST',
        mode:'cors',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });

      if(!resp.ok){ throw new Error('HTTP '+resp.status+' '+await resp.text()); }
      
      // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å JSON –æ—Ç–≤–µ—Ç
      let responseData;
      try {
        responseData = await resp.json();
      } catch {
        responseData = null;
      }

      // –ï—Å–ª–∏ –≤–µ–±—Ö—É–∫ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Ä—Ç—ã - –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏—Ö
      if (responseData && responseData.mind_data) {
        displayMindData(responseData.mind_data);
        feedback.style.color='green'; 
        feedback.textContent='–ö–∞—Ä—Ç–∞ –∑–Ω–∞–Ω–∏–π —Å–æ–∑–¥–∞–Ω–∞!';
        setTimeout(() => {
          close();
          hideLoading();
        }, 1000);
      } else {
        // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç - –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º
        feedback.style.color='green'; 
        feedback.textContent='–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.';
        setTimeout(() => {
          close();
          hideLoading();
        }, 900);
      }
      
    }catch(err){
      feedback.style.color='crimson'; 
      feedback.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ' + (err.message||err);
      hideLoading();
    }
  });

  btn.addEventListener('click', open);
  closeBtn.addEventListener('click', close);
  modal.addEventListener('click', (e)=>{ if(e.target===modal) close(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });

  // –ê–≤—Ç–æ-–æ—Ç–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  setTimeout(open, 100);

  // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
  main();
})();
</script>
</body>
</html>
