<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>sotiio map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/style/jsmind.css" />
  <style>
    /* ... ваш существующий CSS ... */
    
    /* Добавляем стили для индикатора загрузки */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 12000;
      flex-direction: column;
      gap: 16px;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--sel, #ff622b);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .loading-text {
      font-size: 16px;
      color: #333;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
<div id="wrap">
  <div id="jsmind_container"></div>

  <!-- Добавляем индикатор загрузки -->
  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-spinner"></div>
    <div class="loading-text">Создаём карту знаний...</div>
  </div>

  <aside id="drawer" aria-hidden="true">
    <!-- ... существующий drawer код ... -->
  </aside>
</div>

<script src="/static/js/jsmind.js"></script>
<script>
(function(){
  const qs=new URLSearchParams(location.search);
  const task_id=qs.get('task');
  const filename=qs.get('name');

  const jm=new jsMind({
    container:'jsmind_container',
    editable:false, support_html:true,
    view:{hmargin:140, vmargin:30, line_style:'curved'},
    layout:{hspace:80, vspace:20, pspace:10, direction:'right'}
  });

  // Функции для работы с уровнями узлов
  function tagLevels() {
    const root = jm.get_root();
    if (!root) return;
    
    const walk = (node, level) => {
      const el = document.querySelector(`.jmnode[nodeid="${node.id}"]`);
      if (el) {
        el.classList.remove('lvl-0', 'lvl-1', 'lvl-2', 'lvl-3');
        if (level === 0) {
          el.classList.add('jsmind-root');
        } else {
          el.classList.add('lvl-' + Math.min(level, 3));
        }
      }
      
      if (node.children) {
        node.children.forEach(child => walk(child, level + 1));
      }
    };
    
    walk(root, 0);
  }

  // Функции для drawer (оставляем без изменений)
  function renderMeta(node){ /* ... */ }
  function renderWiki(node){ /* ... */ }
  function renderRaw(node){ /* ... */ }
  function escapeHtml(s){ /* ... */ }

  // Функции для показа/скрытия загрузки
  function showLoading() {
    document.getElementById('loadingOverlay').classList.remove('hidden');
  }
  
  function hideLoading() {
    document.getElementById('loadingOverlay').classList.add('hidden');
  }

  // Функция для отображения карты из данных
  function displayMindData(mindData) {
    try {
      // Очищаем текущую карту
      jm.clear();
      
      // Загружаем новые данные
      jm.show(mindData);
      
      // Настраиваем отображение
      jm.collapse_all();
      const root = jm.get_root();
      if (root) jm.expand_node(root.id);
      
      // Добавляем классы уровням после отрисовки
      setTimeout(() => {
        tagLevels();
        jm.resize();
      }, 100);
      
    } catch (error) {
      console.error('Ошибка при отображении карты:', error);
      alert('Ошибка при отображении карты знаний');
    }
  }

  // Инициализация drawer (оставляем без изменений)
  (function initDrawer(){
    // ... ваш существующий код drawer ...
  })();

  // Основная функция загрузки данных
  async function loadInitialData(){
    if (!task_id || !filename) return;
    
    showLoading();
    try {
      const url=`/download_files_pyrus?task_id=${encodeURIComponent(task_id)}&filename=${encodeURIComponent(filename)}&match_mode=exact&versions=latest`;
      const res=await fetch(url); 
      const raw=await res.json();
      const conv=await fetch('/json_2_jm',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(raw)
      });
      const mind=await conv.json();
      displayMindData(mind);
    } catch (error) {
      console.error('Ошибка загрузки данных:', error);
      alert('Ошибка загрузки начальных данных');
    } finally {
      hideLoading();
    }
  }

  // Модифицируем функцию отправки вебхука для обработки ответа
  async function submitSurveyAndLoadMap(role, subject, chosenOptions) {
    const map_id = mapIdFromNow();
    
    const payload = {
      source: 'sotiio_web_survey',
      map_id,
      user_story: {
        "I_as...": role,
        "Want_to_discover_a_universe...": subject,
        "So_that...": chosenOptions,
        timestamp: (new Date()).toISOString()
      }
    };

    showLoading();
    
    try {
      const resp = await fetch('https://n8n.sotiio.com/webhook/us', {
        method:'POST',
        mode:'cors',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });

      if(!resp.ok){ 
        throw new Error('HTTP '+resp.status+' '+await resp.text()); 
      }
      
      // Ожидаем JSON ответ от вебхука
      const responseData = await resp.json();
      
      // Проверяем, содержит ли ответ данные для карты
      if (responseData && responseData.mind_data) {
        // Отображаем полученные данные
        displayMindData(responseData.mind_data);
        return true;
      } else {
        throw new Error('Вебхук не вернул данные для визуализации');
      }
      
    } catch (error) {
      console.error('Ошибка при отправке:', error);
      alert('Ошибка: ' + (error.message||error));
      return false;
    } finally {
      hideLoading();
    }
  }

  // Функция генерации ID (оставляем без изменений)
  function two(n){ return String(n).padStart(2,'0'); }
  function mapIdFromNow(){
    const d = new Date();
    const ss = two(d.getSeconds());
    const mm = two(d.getMinutes());
    const hh = two(d.getHours());
    const dd = two(d.getDate());
    const MM = two(d.getMonth()+1);
    const yy = two(d.getFullYear()%100);
    return `${ss}${mm}${hh}${dd}${MM}${yy}`;
  }

  // Модифицируем обработчик отправки формы
  document.getElementById('sotiio_submit').addEventListener('click', async ()=>{
    const role = document.querySelector('input[name="role"]:checked')?.value;
    const subject = document.getElementById('sotiio_subject').value.trim();
    const chosen = Array.from(document.querySelectorAll('.option-card.selected')).map(x=>x.dataset.value);
    const feedback = document.getElementById('sotiio_feedback');

    if(!role){ 
      feedback.style.color='crimson'; 
      feedback.textContent='Выберите роль.'; 
      return; 
    }
    if(!subject){ 
      feedback.style.color='crimson'; 
      feedback.textContent='Укажите тему/вселенную.'; 
      return; 
    }
    if(chosen.length===0){ 
      feedback.style.color='crimson'; 
      feedback.textContent='Выберите хотя бы один вариант в «Чтобы…» или добавьте свой.'; 
      return; 
    }

    feedback.style.color='#333'; 
    feedback.textContent='Создаём карту знаний...';
    
    const success = await submitSurveyAndLoadMap(role, subject, chosen);
    
    if (success) {
      feedback.style.color='green'; 
      feedback.textContent='Карта знаний создана!';
      setTimeout(() => {
        document.getElementById('sotiio_modal').style.display = 'none';
        document.body.style.overflow = '';
      }, 1000);
    } else {
      feedback.style.color='crimson'; 
      feedback.textContent = 'Ошибка при создании карты';
    }
  });

  // Загружаем начальные данные при загрузке страницы
  window.addEventListener('DOMContentLoaded', () => {
    loadInitialData();
    window.addEventListener('resize', () => { jm.resize(); });
  });

})();
</script>

<!-- ... остальная часть вашего HTML с формой survey ... -->
