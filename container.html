<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>sotiio container</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #1e1e1e;
      color: #f5f5f5;
      overflow: hidden;
    }
    
    #drawer {
      height: 100vh;
      width: 100%;
      background: #222222;
      color: #f5f5f5;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .dw-tabs {
      display: flex;
      background: #262626;
      border-bottom: 1px solid #333;
    }
    
    .dw-tab {
      flex: 1;
      padding: 12px 10px;
      text-align: center;
      cursor: pointer;
      border: 0;
      background: transparent;
      font-weight: 500;
      color: #a3a3a3;
      border-bottom: 2px solid transparent;
      font-family: inherit;
      font-size: 13px;
    }
    
    .dw-tab.active {
      background: #262626;
      border-bottom: 2px solid #34a2db;
      color: #f5f5f5;
    }
    
    .dw-body {
      padding: 12px 16px;
      overflow: auto;
      height: 100%;
      background: #222222;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    pre {
      margin: 0;
      padding: 12px;
      background: #181818;
      border: 1px solid #333;
      border-radius: 10px;
      white-space: pre-wrap;
      word-break: break-word;
      font: 12px/1.45 ui-monospace, Menlo, Consolas, monospace;
      color: #e5e5e5;
    }
    
    table.meta {
      width: 100%;
      border-collapse: collapse;
      background: #181818;
      border: 1px solid #333;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 12px;
    }
    
    table.meta th, table.meta td {
      padding: 10px 12px;
      border-bottom: 1px solid #333;
      font-size: 13px;
    }
    
    table.meta th {
      width: 30%;
      background: #202020;
      text-align: left;
      color: #d4d4d4;
    }
    
    table.meta td {
      color: #f5f5f5;
    }
    
    .wiki-item {
      background: #181818;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 10px 12px;
      margin: 0 0 10px;
    }
    
    .wiki-item h3 {
      margin: 0 0 6px;
      font-size: 14px;
      color: #f5f5f5;
    }
    
    .wiki-item div {
      font-size: 13px;
      color: #d4d4d4;
      line-height: 1.4;
    }
    
    .empty {
      color: #9ca3af;
      font-style: italic;
      padding: 16px 0;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <aside id="drawer" aria-hidden="false">
    <div class="dw-tabs">
      <button class="dw-tab active" data-tab="meta">Meta</button>
      <button class="dw-tab" data-tab="wiki">Wiki</button>
      <button class="dw-tab" data-tab="links">Links</button>
      <button class="dw-tab" data-tab="raw">Raw Data</button>
    </div>
    <div class="dw-body">
      <div id="tab-meta" class="tab-content active">
        <div class="empty">Выберите узел на карте для просмотра деталей</div>
      </div>
      <div id="tab-wiki" class="tab-content">
        <div class="empty">Выберите узел на карте для просмотра деталей</div>
      </div>
      <div id="tab-links" class="tab-content">
        <div class="empty">Выберите узел на карте для просмотра деталей</div>
      </div>
      <div id="tab-raw" class="tab-content">
        <pre id="raw-pre">Выберите узел на карте для просмотра деталей</pre>
      </div>
    </div>
  </aside>

  <script>
  (function(){
    // Вкладки
    document.querySelectorAll('.dw-tab').forEach(t=>{
      t.addEventListener('click',()=>{
        const id = t.getAttribute('data-tab');
        document.querySelectorAll('.dw-tab').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        document.getElementById('tab-'+id).classList.add('active');
      });
    });

    function escapeHtml(s){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#39;");
    }

    // Новый единый формат payload:
    // { map_id, node_id, label, meta, raw, meta_error? }
    function extractCore(nodeLike){
      const d = nodeLike && typeof nodeLike === 'object' ? nodeLike : {};

      const map_id =
        d.map_id ??
        (d.data && d.data.map_id) ??
        null;

      const node_id =
        d.node_id ??
        d.id ??
        (d.data && d.data.data && d.data.data.node_id) ??
        (d.data && d.data.node_id) ??
        null;

      const label =
        d.label ??
        d.topic ??
        (d.data && d.data.data && d.data.data.label) ??
        (d.data && d.data.label) ??
        null;

      const meta =
        d.meta ??
        (d.raw && d.raw.meta) ??
        (d.data && d.data.data && d.data.data.meta) ??
        (d.data && d.data.meta) ??
        null;

      const raw = d.raw != null ? d.raw : d;

      return { map_id, node_id, label, meta, raw, meta_error: d.meta_error };
    }

    function renderMeta(core){
      const box = document.getElementById('tab-meta');

      const rows = [
        ['Map ID', core.map_id || '—'],
        ['ID', core.node_id || '—'],
        ['Название', core.label || '—'],
      ];

      const pre = core.meta ? JSON.stringify(core.meta, null, 2) : '{}';

      const metaErrorBlock = core.meta_error
        ? `<div class="empty">Ошибка загрузки meta: ${escapeHtml(core.meta_error)}</div>`
        : '';

      box.innerHTML = `
        <table class="meta">
          <tbody>
            ${rows.map(r=>`<tr><th>${escapeHtml(r[0])}</th><td>${escapeHtml(r[1])}</td></tr>`).join('')}
          </tbody>
        </table>
        ${metaErrorBlock}
        <div class="empty">Мета-данные (сырые)</div>
        <pre>${escapeHtml(pre)}</pre>
      `;
    }

    function renderWiki(core){
      const box = document.getElementById('tab-wiki');
      const meta = core.meta;
      
      if(!meta || typeof meta!=='object'){ 
        box.innerHTML='<div class="empty">Для этого узла нет информации Wiki.</div>'; 
        return; 
      }
      
      const inner = (meta.meta && typeof meta.meta==='object') ? meta.meta : {};
      const piles = [
        inner.text, inner.number, inner.select, inner.checkbox, inner.date,
        meta.meta_text, meta.meta_number, meta.meta_select, meta.meta_checkbox, meta.meta_date
      ].filter(Array.isArray);
      
      const items = [];
      for(const arr of piles){ 
        for(const it of arr){ 
          if(it && typeof it==='object'){ 
            items.push({n:it.name??'', v:it.value??''}); 
          } 
        } 
      }
      
      if(!items.length){ 
        box.innerHTML='<div class="empty">Для этого узла нет информации Wiki.</div>';
        return; 
      }
      
      box.innerHTML = items.map(({n,v})=>`
        <div class="wiki-item">
          <h3>${escapeHtml(n)}</h3>
          <div>${escapeHtml(v)}</div>
        </div>
      `).join('');
    }

    function renderLinks(core){
      const box = document.getElementById('tab-links');
      // Пока нет структуры ссылок — просто заглушка
      box.innerHTML = '<div class="empty">Для этого узла нет информации Links.</div>';
    }

    function renderRaw(raw){
      const pre = document.getElementById('raw-pre');
      let txt = 'null';
      try{ 
        txt = JSON.stringify(raw??null, null, 2);
      }catch(e){
        txt = String(raw);
      }
      pre.textContent = txt;
    }

    function setData(nodeLike){ 
      const core = extractCore(nodeLike);
      renderMeta(core); 
      renderWiki(core); 
      renderLinks(core);
      renderRaw(core.raw); 
    }

    // Связь с index.html
    window.addEventListener('message', (ev)=>{ 
      const msg = ev.data || {}; 
      if(msg.type === 'container:set') setData(msg.payload); 
    });

    // Ручной API
    window.ContainerAPI = { setData };
  })();
  </script>
</body>
</html>
