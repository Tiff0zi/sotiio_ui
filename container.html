<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>sotiio container</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #2d2d2d;
      color: #e0e0e0;
      overflow: hidden;
    }
    
    #drawer {
      height: 100%;
      width: 100%;
      box-sizing: border-box;
      padding: 12px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .dw-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 4px;
    }

    .dw-header-id {
      font-size: 12px;
      color: #aaa;
    }

    .dw-header-label {
      font-size: 18px;
      font-weight: 600;
      color: #fff;
    }

    .dw-tabs {
      display: flex;
      border-bottom: 1px solid #444;
      gap: 4px;
    }

    .dw-tab {
      background: transparent;
      border: none;
      color: #aaa;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 13px;
      border-radius: 6px 6px 0 0;
      border: 1px solid transparent;
      border-bottom: none;
      transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;
    }

    .dw-tab.active {
      background: #3a3a3a;
      color: #fff;
      border-color: #555;
      border-bottom: 1px solid #3a3a3a;
    }

    .dw-body {
      flex: 1;
      border-radius: 0 8px 8px 8px;
      border: 1px solid #444;
      background: #252525;
      padding: 12px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .tab-content {
      display: none;
      flex: 1;
      overflow: auto;
    }

    .tab-content.active {
      display: block;
    }

    .empty {
      color: #777;
      font-size: 13px;
      padding: 8px 0;
    }

    .loading {
      color: #6ab0ff;
      font-size: 13px;
      padding: 8px 0;
    }

    .error {
      color: #ff6a6a;
      font-size: 13px;
      padding: 8px 0;
      white-space: pre-wrap;
    }

    .meta-section {
      margin-bottom: 16px;
    }
    
    .meta-section h3 {
      margin: 0 0 4px;
      font-size: 14px;
      font-weight: 600;
      color: #f0f0f0;
    }
    
    .meta-section small {
      display: block;
      margin-top: 2px;
      font-size: 11px;
      color: #999;
    }
    
    .meta-block {
      background: #2f2f2f;
      border-radius: 6px;
      border: 1px solid #444;
      padding: 8px 10px;
      font-size: 13px;
      line-height: 1.4;
      white-space: pre-wrap;
      word-break: break-word;
    }

    pre {
      background: #1e1e1e;
      border-radius: 6px;
      padding: 8px 10px;
      margin: 0;
      font-family: Menlo, Monaco, Consolas, 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.4;
      overflow: auto;
      border: 1px solid #444;
    }

    table.meta {
      width: 100%;
      border-collapse: collapse;
      background: #3d3d3d;
      border: 1px solid #444;
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 16px;
    }
    
    table.meta th, table.meta td {
      padding: 6px 8px;
      font-size: 12px;
      text-align: left;
      border-bottom: 1px solid #444;
    }
    
    table.meta th {
      width: 30%;
      color: #aaa;
      background: #363636;
      font-weight: 500;
    }
    
    table.meta tr:last-child th,
    table.meta tr:last-child td {
      border-bottom: none;
    }

    .links-list {
      list-style: none;
      margin: 0;
      padding: 0;
      font-size: 13px;
    }

    .links-list li {
      margin-bottom: 4px;
    }

    .links-list a {
      color: #64b5f6;
      text-decoration: none;
    }

    .links-list a:hover {
      text-decoration: underline;
    }

    .wiki-item {
      margin-bottom: 12px;
    }

    .wiki-item h3 {
      margin: 0 0 4px;
      font-size: 14px;
      color: #fff;
    }

    .wiki-item div {
      font-size: 13px;
      color: #ddd;
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>
<body>
  <aside id="drawer" aria-hidden="false">
    <div class="dw-header">
      <div class="dw-header-id" id="hdr-id">map_id · node_id</div>
      <div class="dw-header-label" id="hdr-label">Выберите узел</div>
    </div>
    <div class="dw-tabs">
      <button class="dw-tab active" data-tab="wiki">Wiki</button>
      <button class="dw-tab" data-tab="raw">Raw Data</button>
    </div>
    <div class="dw-body">
      <div id="tab-wiki" class="tab-content active">
        <div class="empty">Выберите узел на карте для просмотра деталей</div>
      </div>
      <div id="tab-raw" class="tab-content">
        <pre id="raw-pre">Выберите узел на карте для просмотра деталей</pre>
      </div>
    </div>
  </aside>

  <script>
  (function(){
    let currentMapId = null;
    let currentNodeId = null;
    let currentLabel = null;

    // Вкладки
    document.querySelectorAll('.dw-tab').forEach(t=>{
      t.addEventListener('click',()=>{
        const id = t.getAttribute('data-tab');
        document.querySelectorAll('.dw-tab').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        document.getElementById('tab-'+id).classList.add('active');
      });
    });

    function escapeHtml(s){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }

    function showLoading(tabId, message = "Загрузка данных...") {
      const tab = document.getElementById(tabId);
      tab.innerHTML = `<div class="loading">${message}</div>`;
    }

    function showError(tabId, message) {
      const tab = document.getElementById(tabId);
      tab.innerHTML = `<div class="error">${message}</div>`;
    }

    function fetchMetaData(mapId, nodeId) {
      return fetch('https://n8n.sotiio.com/webhook/get_meta', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ map_id: mapId, node_id: nodeId })
      })
        .then(res => {
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return res.json();
        })
        .catch(err => {
          console.error('Ошибка запроса meta-данных:', err);
          throw err;
        });
    }

    function renderMeta(nodeLike) {
      const tab = document.getElementById('tab-meta');
      if (!tab) return;

      showLoading('tab-meta');

      const hdrId = document.getElementById('hdr-id');
      const hdrLabel = document.getElementById('hdr-label');

      const mapId  = currentMapId || nodeLike?.map_id || '';
      const nodeId = currentNodeId || nodeLike?.id || nodeLike?.node_id || '';
      const label  = currentLabel || nodeLike?.label || nodeLike?.topic || nodeLike?.name || '';

      hdrId.textContent = `${mapId || '—'} · ${nodeId || '—'}`;
      hdrLabel.textContent = label || 'Без имени';

      const rows = [
        ['map_id', mapId || '—'],
        ['node_id', nodeId || '—'],
        ['label', label || '—'],
      ];
      
      const baseHtml = `
        <div class="meta-section">
          <h3>Основная информация</h3>
          <table class="meta">
            <tbody>
              ${rows.map(r => `<tr><th>${r[0]}</th><td>${escapeHtml(r[1])}</td></tr>`).join('')}
            </tbody>
          </table>
        </div>
      `;

      // Запрашиваем дополнительные meta-данные
      if (currentMapId && currentNodeId) {
        fetchMetaData(currentMapId, currentNodeId)
          .then(metaData => {
            let metaHtml = baseHtml;
            
            if (metaData && Object.keys(metaData).length > 0) {
              metaHtml += `
                <div class="meta-section">
                  <h3>Дополнительные данные</h3>
                  <pre>${escapeHtml(JSON.stringify(metaData, null, 2))}</pre>
                </div>
              `;
            } else {
              metaHtml += `<div class="empty">Дополнительные meta-данные отсутствуют</div>`;
            }
            
            tab.innerHTML = metaHtml;
          })
          .catch(error => {
            console.error('Ошибка загрузки meta-данных:', error);
            showError('tab-meta', `Ошибка загрузки meta-данных: ${escapeHtml(error.message)}`);
          });
      } else {
        tab.innerHTML = baseHtml + `<div class="empty">Для загрузки meta-данных требуется map_id и node_id</div>`;
      }
    }

    function renderWiki(nodeLike) {
      const box = document.getElementById('tab-wiki');
      showLoading('tab-wiki', 'Загрузка wiki...');

      const hdrId = document.getElementById('hdr-id');
      const hdrLabel = document.getElementById('hdr-label');

      const mapId  = currentMapId || nodeLike?.map_id || '';
      const nodeId = currentNodeId || nodeLike?.id || nodeLike?.node_id || '';
      const label  = currentLabel || nodeLike?.label || nodeLike?.topic || nodeLike?.name || '';

      hdrId.textContent = `${mapId || '—'} · ${nodeId || '—'}`;
      hdrLabel.textContent = label || 'Без имени';

      const d = nodeLike?.data?.data || nodeLike?.data || nodeLike || {};
      
      if (currentMapId && currentNodeId) {
        fetchMetaData(currentMapId, currentNodeId)
          .then(metaData => {
            if (metaData && metaData.wiki) {
              // Если есть wiki данные в meta
              const wikiContent = typeof metaData.wiki === 'string' ? metaData.wiki : JSON.stringify(metaData.wiki, null, 2);
              box.innerHTML = `
                <div class="wiki-item">
                  <h3>Wiki информация</h3>
                  <div>${escapeHtml(wikiContent)}</div>
                </div>
              `;
            } else if (metaData && metaData.description) {
              // Используем description как wiki
              box.innerHTML = `
                <div class="wiki-item">
                  <h3>Описание</h3>
                  <div>${escapeHtml(metaData.description)}</div>
                </div>
              `;
            } else {
              box.innerHTML = '<div class="empty">Для этого узла нет wiki-информации.</div>';
            }
          })
          .catch(error => {
            console.error('Ошибка загрузки wiki-данных:', error);
            box.innerHTML = `<div class="error">Ошибка загрузки wiki-данных: ${error.message}</div>`;
          });
      } else if (d && (d.wiki || d.description)) {
        if (d.wiki) {
          const wikiContent = typeof d.wiki === 'string' ? d.wiki : JSON.stringify(d.wiki, null, 2);
          box.innerHTML = `
            <div class="wiki-item">
              <h3>Wiki информация</h3>
              <div>${escapeHtml(wikiContent)}</div>
            </div>
          `;
        } else {
          box.innerHTML = `
            <div class="wiki-item">
              <h3>Описание</h3>
              <div>${escapeHtml(d.description)}</div>
            </div>
          `;
        }
      } else {
        box.innerHTML = '<div class="empty">Для этого узла нет wiki-информации.</div>';
      }
    }

    function renderLinks(nodeLike) {
